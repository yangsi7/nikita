# Fix Plan: E2E Issues from 2025-12-17 Testing

## Executive Summary

Three critical issues were discovered during E2E testing that prevent the full Nikita experience from working:

| Issue | Severity | Effort | Impact |
|-------|----------|--------|--------|
| NEO4J_URI not configured | CRITICAL | 15 min | Memory system completely broken |
| Thread type mismatch | HIGH | 30 min | 0 threads created (80% loss) |
| Thought type mismatch | HIGH | 30 min | 0 thoughts created (100% loss) |

**Total Estimated Effort**: 1.5 hours

---

## Issue 1: NEO4J_URI Not Configured (CRITICAL)

### Problem
Cloud Run has `NEO4J_PASSWORD` but NOT `NEO4J_URI`, causing Stage 6 (Graph Updates) to silently skip.

### Evidence
```bash
# Current env vars (missing NEO4J_URI)
gcloud run services describe nikita-api --format="yaml(spec.template.spec.containers[0].env)"
# Shows NEO4J_PASSWORD but no NEO4J_URI
```

```python
# nikita/context/post_processor.py:464-466
if not settings.neo4j_uri or not settings.neo4j_password:
    logger.debug("Neo4j not configured, skipping graph updates")
    return
```

### Fix

**Step 1**: Create GCP secret for Neo4j URI
```bash
# Get Neo4j Aura URI from dashboard or existing config
# Format: neo4j+s://xxxxxxxx.databases.neo4j.io

# Create secret
echo -n "neo4j+s://YOUR_NEO4J_URI" | gcloud secrets create nikita-neo4j-uri \
  --project=gcp-transcribe-test \
  --data-file=-
```

**Step 2**: Update Cloud Run service
```bash
gcloud run services update nikita-api \
  --region us-central1 \
  --project gcp-transcribe-test \
  --update-secrets="NEO4J_URI=nikita-neo4j-uri:latest"
```

**Step 3**: Verify
```bash
# Check env vars
gcloud run services describe nikita-api \
  --project gcp-transcribe-test \
  --region us-central1 \
  --format="yaml(spec.template.spec.containers[0].env)" | grep NEO4J
```

### Acceptance Criteria
- [ ] NEO4J_URI secret exists in GCP
- [ ] Cloud Run service has NEO4J_URI env var
- [ ] Post-processing logs show graph update activity (not "skipping")

---

## Issue 2: Thread Type Mismatch (HIGH)

### Problem
MetaPromptService returns thread types that don't match THREAD_TYPES, causing all threads except "promise" to be filtered out.

### Evidence

**MetaPrompt template returns** (entity_extraction.meta.md:43-47):
```
unresolved, cliffhanger, promise, curiosity, callback
```

**Database accepts** (context.py:24-27):
```python
THREAD_TYPES = ["follow_up", "question", "promise", ...]
```

**Only "promise" matches!**

### Fix Options

**Option A (Recommended)**: Align THREAD_TYPES with MetaPrompt types
- Pros: MetaPrompt types are semantically richer
- Cons: Need migration if existing data uses old types

**Option B**: Align MetaPrompt with THREAD_TYPES
- Pros: No migration needed
- Cons: Loses semantic richness

### Implementation (Option A)

**File**: `nikita/db/models/context.py`

```python
# Change THREAD_TYPES from:
THREAD_TYPES = [
    "follow_up",
    "question",
    "promise",
    "topic",        # General topic to discuss
    "request",      # Something user asked for
]

# To:
THREAD_TYPES = [
    "unresolved",   # Question asked but not fully answered
    "cliffhanger",  # Story started but not finished
    "promise",      # Something to do/discuss later
    "curiosity",    # Topic Nikita should ask more about
    "callback",     # Reference to revisit for continuity
    # Legacy types (for backwards compatibility)
    "follow_up",
    "question",
    "topic",
    "request",
]
```

### Acceptance Criteria
- [ ] THREAD_TYPES includes all MetaPrompt types
- [ ] New conversation creates threads in database
- [ ] Post-processing logs show threads_created > 0

---

## Issue 3: Thought Type Mismatch (HIGH)

### Problem
1. Post-processor uses wrong key (`type` vs `thought_type`)
2. THOUGHT_TYPES don't match MetaPrompt types

### Evidence

**MetaPrompt returns** (entity_extraction.meta.md:85-90):
```json
{"thought_type": "worry", "content": "..."}
```

**Post-processor reads** (post_processor.py:326-329):
```python
thoughts = [
    {"type": t.get("type", "thinking"), ...}  # WRONG KEY!
    for t in data.get("nikita_thoughts", [])
]
```

**Database accepts** (context.py:39-42):
```python
THOUGHT_TYPES = ["thinking", "wants_to_share", "question", ...]
```

### Fix

**File 1**: `nikita/context/post_processor.py` (line 326-329)

```python
# Change from:
thoughts = [
    {"type": t.get("type", "thinking"), "content": t.get("content", "")}
    for t in data.get("nikita_thoughts", [])
]

# To:
thoughts = [
    {"type": t.get("thought_type", "thinking"), "content": t.get("content", "")}
    for t in data.get("nikita_thoughts", [])
]
```

**File 2**: `nikita/db/models/context.py`

```python
# Change THOUGHT_TYPES from:
THOUGHT_TYPES = [
    "thinking",
    "wants_to_share",
    "question",
    "concern",
    "memory",
]

# To:
THOUGHT_TYPES = [
    "worry",         # Something concerning about the user
    "curiosity",     # Something she wants to know more about
    "anticipation",  # Something she's looking forward to
    "reflection",    # Something that made her think
    "desire",        # Something she wants from/with the user
    # Legacy types (for backwards compatibility)
    "thinking",
    "wants_to_share",
    "question",
    "concern",
    "memory",
]
```

### Acceptance Criteria
- [ ] Post-processor reads `thought_type` key
- [ ] THOUGHT_TYPES includes all MetaPrompt types
- [ ] New conversation creates thoughts in database
- [ ] Post-processing logs show thoughts_created > 0

---

## Implementation Order

1. **NEO4J_URI** (15 min) - Infrastructure, no code changes
2. **Thread types** (30 min) - Code change + test
3. **Thought types** (30 min) - Code change + test
4. **Deploy & Verify** (15 min) - Full E2E test

---

## Verification Plan

After all fixes:

```bash
# 1. Trigger a conversation with existing user
# 2. Wait 15 min OR call process-conversations endpoint
curl -X POST "https://nikita-api-xxx.run.app/api/v1/tasks/process-conversations" \
  -H "Authorization: Bearer $WEBHOOK_SECRET"

# 3. Query database for results
SELECT COUNT(*) FROM conversation_threads;  -- Should be > 0
SELECT COUNT(*) FROM nikita_thoughts;        -- Should be > 0

# 4. Check Neo4j via admin endpoint (requires JWT)
# Or check Cloud Run logs for graph update activity
```

---

## Related Files

| File | Change |
|------|--------|
| `nikita/db/models/context.py` | Update THREAD_TYPES, THOUGHT_TYPES |
| `nikita/context/post_processor.py` | Fix `thought_type` key |
| Cloud Run env vars | Add NEO4J_URI |

---

## Test Coverage

Existing tests should continue to pass. Add new tests:

1. `test_thread_type_extraction` - Verify all MetaPrompt thread types are accepted
2. `test_thought_type_extraction` - Verify all MetaPrompt thought types are accepted
3. `test_neo4j_stage_runs` - Verify graph updates stage executes when configured
