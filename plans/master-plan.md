---
title: Nikita Game Master Plan
created: 2025-01-27T20:23:00Z
updated: 2025-12-03T17:00:00Z
session_id: nikita-meta-prompts-complete
status: active
phases_complete: [1]
phases_in_progress: [2]
phases_pending: [3, 4, 5]
current_audit: "Meta-prompt architecture COMPLETE. 012 at 50%."
notes: "Meta-prompts done. Next: Security hardening + Configuration System (013)."
---

# Nikita Game - Technical Architecture & Implementation Plan

## SDD Orchestration (Dec 2025 Update)

**Status**: All 14 specifications have complete SDD artifacts (spec.md, plan.md, tasks.md, audit-report.md).

### Implementation Order (by dependency)

| Phase | Duration | Specs | Status |
|-------|----------|-------|--------|
| 0. Docs Sync | 1-2 hrs | - | ğŸ”„ In Progress |
| 1A. Security | 8-12 hrs | - (parallel) | âŒ Pending |
| 2. Config | 4-6 hrs | 013 | âŒ Pending |
| 3. Engagement | 8-12 hrs | 014 | âŒ Pending |
| 4. Scoring | 6-8 hrs | 003 | âŒ Pending |
| 5. Context | 10-14 hrs | 012 | âŒ Pending |
| 6. Chapters | 6-8 hrs | 004 | âŒ Pending |
| 7. Decay | 4-6 hrs | 005 | âŒ Pending |
| 8. Vice | 6-8 hrs | 006 | âŒ Pending |
| 9. Telegram | 2-4 hrs | 002 | âŒ Pending |
| 10. Voice | 10-14 hrs | 007 | âŒ Pending |
| 11. Portal | 12-16 hrs | 008 | âŒ Pending |

**Critical Path**: 013 â†’ 014 â†’ 012 (Config â†’ Engagement â†’ Context)

### Security Issues (Pre-Production Blockers)

| Issue | Severity | Est. Fix |
|-------|----------|----------|
| No webhook signature validation | CRITICAL | 2-4 hrs |
| In-memory rate limiting | HIGH | 4-6 hrs |
| No HTML escaping | HIGH | 1 hr |
| Secrets in env vars | HIGH | 4-6 hrs |

### Key Values (Updated Dec 2025)

- Boss thresholds: 55/60/65/70/75%
- Grace periods: 8/16/24/48/72 hours
- Decay rates: 0.8/0.6/0.4/0.3/0.2 per hour
- Claude model: claude-sonnet-4-5-20250929

See full orchestration plan: `/Users/yangsim/.claude/plans/tidy-inventing-nebula.md`

---

## Executive Summary

This document defines the complete technical architecture for **Nikita: Don't Get Dumped** - an AI girlfriend simulation game featuring dual-agent architecture (voice + text), temporal knowledge graphs for memory, and a sophisticated game engine with scoring, chapters, and boss encounters.

---

## 1. High-Level System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              USER INTERFACES                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Telegram Bot      â”‚   Voice Calls       â”‚      Player Portal              â”‚
â”‚   (aiogram 3.x)     â”‚ (ElevenLabs Agent)  â”‚      (Next.js/React)            â”‚
â”‚   â€¢ Text messages   â”‚ â€¢ Real-time voice   â”‚      â€¢ Stats dashboard          â”‚
â”‚   â€¢ Media support   â”‚ â€¢ Emotion controls  â”‚      â€¢ Score history            â”‚
â”‚   â€¢ Webhooks        â”‚ â€¢ <100ms latency    â”‚      â€¢ Chapter progress         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                     â”‚                           â”‚
          â–¼                     â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           API GATEWAY (FastAPI)                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  /telegram/*    â”‚  /voice/*       â”‚  /portal/*      â”‚  /webhooks/*     â”‚ â”‚
â”‚  â”‚  Bot webhooks   â”‚  ElevenLabs CB  â”‚  Stats API      â”‚  External hooks  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ORCHESTRATION LAYER                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Conversation Orchestrator                          â”‚   â”‚
â”‚  â”‚  â€¢ Route to appropriate agent (voice/text)                           â”‚   â”‚
â”‚  â”‚  â€¢ Inject context (chapter, score, history, vice preferences)        â”‚   â”‚
â”‚  â”‚  â€¢ Process response through scoring engine                           â”‚   â”‚
â”‚  â”‚  â€¢ Update memory graphs                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â–¼                           â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   VOICE AGENT       â”‚   â”‚    TEXT AGENT       â”‚   â”‚     GAME ENGINE         â”‚
â”‚   (ElevenLabs)      â”‚   â”‚    (Pydantic AI)    â”‚   â”‚                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Conv AI 2.0 SDK   â”‚   â”‚ â€¢ Claude Sonnet LLM â”‚   â”‚ â€¢ Scoring System        â”‚
â”‚ â€¢ Server Tools:     â”‚   â”‚ â€¢ Structured Output â”‚   â”‚ â€¢ Chapter Manager       â”‚
â”‚   - get_context     â”‚   â”‚ â€¢ Tools:            â”‚   â”‚ â€¢ Boss Encounters       â”‚
â”‚   - score_response  â”‚   â”‚   - get_memory      â”‚   â”‚ â€¢ Decay Calculator      â”‚
â”‚   - update_memory   â”‚   â”‚   - score_response  â”‚   â”‚ â€¢ Vice Discovery        â”‚
â”‚ â€¢ Emotion controls  â”‚   â”‚   - update_state    â”‚   â”‚ â€¢ Conflict Handler      â”‚
â”‚ â€¢ Voice synthesis   â”‚   â”‚ â€¢ Dependency inject â”‚   â”‚ â€¢ Daily Summaries       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                         â”‚                           â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         MEMORY & KNOWLEDGE LAYER                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                     Graphiti (Temporal KG)                            â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  Nikita Graph  â”‚  â”‚   User Graph   â”‚  â”‚  Relationship Graph    â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  Her life,     â”‚  â”‚  What she      â”‚  â”‚  Shared history,       â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  work, story   â”‚  â”‚  knows of you  â”‚  â”‚  episodes, jokes       â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         PERSISTENCE LAYER                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                     Supabase (PostgreSQL)                             â”‚   â”‚
â”‚  â”‚  â€¢ User profiles + auth        â€¢ Conversation logs                   â”‚   â”‚
â”‚  â”‚  â€¢ Relationship state          â€¢ pgVector embeddings                 â”‚   â”‚
â”‚  â”‚  â€¢ Score history               â€¢ Vice preferences                    â”‚   â”‚
â”‚  â”‚  â€¢ Chapter/Boss progress       â€¢ Daily summaries                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                     Neo4j (Graph Database)                            â”‚   â”‚
â”‚  â”‚  â€¢ Graphiti temporal knowledge graphs                                â”‚   â”‚
â”‚  â”‚  â€¢ Entity nodes, relationship edges                                  â”‚   â”‚
â”‚  â”‚  â€¢ Temporal versioning                                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Tech Stack Specification

| Layer | Technology | Purpose | Documentation |
|-------|------------|---------|---------------|
| **Voice Agent** | ElevenLabs Conversational AI 2.0 | Real-time voice conversations | [Docs](https://elevenlabs.io/docs/agents-platform) |
| **Text Agent** | Pydantic AI + Claude Sonnet | Structured text responses | [Docs](https://ai.pydantic.dev/) |
| **API Backend** | FastAPI (Python 3.11+) | REST/WebSocket API | [Docs](https://fastapi.tiangolo.com/) |
| **Telegram Bot** | aiogram 3.x | Async Telegram integration | [Docs](https://docs.aiogram.dev/) |
| **Memory/KG** | Graphiti | Temporal knowledge graphs | [Docs](https://github.com/getzep/graphiti) |
| **Database** | Supabase (PostgreSQL + pgVector) | Persistence + embeddings | [Docs](https://supabase.com/docs) |
| **Graph DB** | Neo4j Aura (Free Tier) | Graphiti backend (managed, zero-install) | [Docs](https://neo4j.com/docs/) |
| **Scheduling** | pg_cron + Supabase Edge Functions | Background jobs (decay, summaries) | [Docs](https://supabase.com/docs/guides/database/extensions/pg_cron) |
| **Player Portal** | Next.js + React | Stats dashboard | [Docs](https://nextjs.org/docs) |
| **Compute** | Google Cloud Run | Serverless API hosting (scales to zero) | [Docs](https://cloud.google.com/run/docs) |

---

## 3. Module Breakdown

### 3.1 Core Modules

```
nikita/
â”œâ”€â”€ agents/                    # AI Agent Implementations
â”‚   â”œâ”€â”€ base_agent.py          # Shared agent interface
â”‚   â”œâ”€â”€ voice_agent.py         # ElevenLabs integration
â”‚   â”œâ”€â”€ text_agent.py          # Pydantic AI text agent
â”‚   â””â”€â”€ tools/                 # Shared tools for both agents
â”‚       â”œâ”€â”€ memory_tools.py    # get_memory, update_memory
â”‚       â”œâ”€â”€ scoring_tools.py   # evaluate_response, get_score
â”‚       â””â”€â”€ context_tools.py   # get_chapter, get_vice_prefs
â”‚
â”œâ”€â”€ engine/                    # Game Engine
â”‚   â”œâ”€â”€ scoring/
â”‚   â”‚   â”œâ”€â”€ calculator.py      # Composite score calculation
â”‚   â”‚   â”œâ”€â”€ metrics.py         # Intimacy, Passion, Trust, Secureness
â”‚   â”‚   â””â”€â”€ analyzer.py        # Response analysis for scoring
â”‚   â”œâ”€â”€ chapters/
â”‚   â”‚   â”œâ”€â”€ state_machine.py   # Chapter progression FSM
â”‚   â”‚   â”œâ”€â”€ boss_encounters.py # Boss fight logic
â”‚   â”‚   â””â”€â”€ conditions.py      # Unlock conditions
â”‚   â”œâ”€â”€ decay/
â”‚   â”‚   â”œâ”€â”€ calculator.py      # Daily decay by chapter
â”‚   â”‚   â””â”€â”€ scheduler.py       # Decay job scheduling
â”‚   â”œâ”€â”€ vice/
â”‚   â”‚   â”œâ”€â”€ discovery.py       # Vice preference detection
â”‚   â”‚   â”œâ”€â”€ categories.py      # 8 vice categories
â”‚   â”‚   â””â”€â”€ intensity.py       # Intensity level tracking
â”‚   â””â”€â”€ conflicts/
â”‚       â”œâ”€â”€ detector.py        # Conflict type detection
â”‚       â”œâ”€â”€ resolution.py      # Resolution scoring
â”‚       â””â”€â”€ silence.py         # Strategic silence logic
â”‚
â”œâ”€â”€ memory/                    # Memory Pipeline
â”‚   â”œâ”€â”€ graphiti_client.py     # Graphiti wrapper
â”‚   â”œâ”€â”€ graphs/
â”‚   â”‚   â”œâ”€â”€ nikita_graph.py    # Her life/work/story
â”‚   â”‚   â”œâ”€â”€ user_graph.py      # What she knows of user
â”‚   â”‚   â””â”€â”€ relationship_graph.py # Shared history
â”‚   â”œâ”€â”€ embeddings.py          # pgVector operations
â”‚   â””â”€â”€ context_builder.py     # Assemble context for prompts
â”‚
â”œâ”€â”€ platforms/                 # Platform Integrations
â”‚   â”œâ”€â”€ telegram/
â”‚   â”‚   â”œâ”€â”€ bot.py             # aiogram bot setup
â”‚   â”‚   â”œâ”€â”€ handlers.py        # Message handlers
â”‚   â”‚   â””â”€â”€ middleware.py      # Auth, rate limiting
â”‚   â”œâ”€â”€ voice/
â”‚   â”‚   â”œâ”€â”€ elevenlabs.py      # ElevenLabs SDK wrapper
â”‚   â”‚   â”œâ”€â”€ callbacks.py       # Server tool callbacks
â”‚   â”‚   â””â”€â”€ session.py         # Voice session management
â”‚   â””â”€â”€ portal/
â”‚       â””â”€â”€ api.py             # Portal REST endpoints
â”‚
â”œâ”€â”€ db/                        # Database Layer
â”‚   â”œâ”€â”€ models/                # SQLAlchemy/Pydantic models
â”‚   â”‚   â”œâ”€â”€ user.py
â”‚   â”‚   â”œâ”€â”€ conversation.py
â”‚   â”‚   â”œâ”€â”€ score_history.py
â”‚   â”‚   â””â”€â”€ daily_summary.py
â”‚   â”œâ”€â”€ repositories/          # Data access patterns
â”‚   â””â”€â”€ migrations/            # Alembic migrations
â”‚
â”œâ”€â”€ prompts/                   # Prompt Templates
â”‚   â”œâ”€â”€ nikita_persona.py      # Core personality
â”‚   â”œâ”€â”€ chapter_contexts.py    # Per-chapter variations
â”‚   â”œâ”€â”€ boss_scripts.py        # Boss encounter prompts
â”‚   â””â”€â”€ summary_templates.py   # Daily/conversation summaries
â”‚
â”œâ”€â”€ api/                       # FastAPI Application
â”‚   â”œâ”€â”€ main.py                # App entrypoint
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ telegram.py        # Webhook handlers
â”‚   â”‚   â”œâ”€â”€ voice.py           # ElevenLabs callbacks
â”‚   â”‚   â”œâ”€â”€ portal.py          # Stats API
â”‚   â”‚   â””â”€â”€ admin.py           # Admin endpoints
â”‚   â””â”€â”€ middleware/
â”‚       â”œâ”€â”€ auth.py
â”‚       â””â”€â”€ rate_limit.py
â”‚
â””â”€â”€ tasks/                     # Background Jobs
    â”œâ”€â”€ decay_task.py          # Daily decay calculation
    â”œâ”€â”€ summary_task.py        # Generate daily summaries
    â””â”€â”€ cleanup_task.py        # Old data cleanup
```

---

## 4. Data Flow Diagrams

### 4.1 Message Processing Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Telegram   â”‚â”€â”€â”€â”€â–¶â”‚  API Gateway â”‚â”€â”€â”€â”€â–¶â”‚      Conversation Orchestrator   â”‚
â”‚   Message    â”‚     â”‚  /telegram/* â”‚     â”‚                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                         â”‚
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚                                   â”‚                   â”‚
                     â–¼                                   â–¼                   â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  1. Load Context  â”‚               â”‚  2. Get Memory    â”‚  â”‚ 3. Get State   â”‚
         â”‚  (Chapter, Score, â”‚               â”‚  (Graphiti query) â”‚  â”‚ (Vice prefs,   â”‚
         â”‚   Vice prefs)     â”‚               â”‚                   â”‚  â”‚  last convo)   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                                   â”‚                    â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                       â”‚
                                                       â–¼
                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                          â”‚   4. Build Prompt      â”‚
                                          â”‚   â€¢ Nikita persona     â”‚
                                          â”‚   â€¢ Chapter context    â”‚
                                          â”‚   â€¢ Memory injection   â”‚
                                          â”‚   â€¢ User message       â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                      â”‚
                                                      â–¼
                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                          â”‚   5. Text Agent        â”‚
                                          â”‚   (Pydantic AI +       â”‚
                                          â”‚    Claude Sonnet)      â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                      â”‚
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚                                â”‚                        â”‚
                     â–¼                                â–¼                        â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  6. Score Responseâ”‚            â”‚  7. Update Memory â”‚    â”‚  8. Check Boss    â”‚
         â”‚  â€¢ Analyze text   â”‚            â”‚  â€¢ Graphiti add   â”‚    â”‚  â€¢ Threshold met? â”‚
         â”‚  â€¢ Update metrics â”‚            â”‚  â€¢ User graph     â”‚    â”‚  â€¢ Trigger boss?  â”‚
         â”‚  â€¢ Apply deltas   â”‚            â”‚  â€¢ Relationship   â”‚    â”‚                   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                                â”‚                        â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                    â”‚
                                                    â–¼
                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                          â”‚   9. Send Response     â”‚
                                          â”‚   via Telegram         â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 Voice Call Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User initiates  â”‚â”€â”€â”€â”€â”€â–¶â”‚  ElevenLabs      â”‚â”€â”€â”€â”€â”€â–¶â”‚   Agent receives call    â”‚
â”‚  voice call      â”‚      â”‚  Conversation    â”‚      â”‚   (WebSocket connection) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                 â”‚
                                                                 â–¼
                                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                    â”‚   Server Tool Calls    â”‚
                                                    â”‚   (via ElevenLabs SDK) â”‚
                                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚                                      â”‚                 â”‚
                          â–¼                                      â–¼                 â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  get_context()    â”‚                  â”‚  get_memory()     â”‚  â”‚ score_turn()â”‚
              â”‚  Returns:         â”‚                  â”‚  Returns:         â”‚  â”‚ Updates:    â”‚
              â”‚  â€¢ Chapter        â”‚                  â”‚  â€¢ Recent history â”‚  â”‚ â€¢ Metrics   â”‚
              â”‚  â€¢ Score          â”‚                  â”‚  â€¢ User facts     â”‚  â”‚ â€¢ Score     â”‚
              â”‚  â€¢ Vice prefs     â”‚                  â”‚  â€¢ Relationship   â”‚  â”‚             â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚                                      â”‚                 â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                 â”‚
                                                                 â–¼
                                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                    â”‚   Voice response       â”‚
                                                    â”‚   (with emotion ctrl)  â”‚
                                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. Scoring System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         SCORING PIPELINE                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Response Analyzer (LLM-based)                      â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  Input: User message + Nikita response + Context                     â”‚   â”‚
â”‚  â”‚  Output: Structured analysis (Pydantic model)                        â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  class ResponseAnalysis(BaseModel):                                  â”‚   â”‚
â”‚  â”‚      intimacy_delta: float      # -10 to +10                         â”‚   â”‚
â”‚  â”‚      passion_delta: float       # -10 to +10                         â”‚   â”‚
â”‚  â”‚      trust_delta: float         # -10 to +10                         â”‚   â”‚
â”‚  â”‚      secureness_delta: float    # -10 to +10                         â”‚   â”‚
â”‚  â”‚      conflict_detected: bool                                         â”‚   â”‚
â”‚  â”‚      conflict_type: Optional[ConflictType]                           â”‚   â”‚
â”‚  â”‚      vice_signals: List[ViceSignal]                                  â”‚   â”‚
â”‚  â”‚      engagement_quality: float  # 0 to 1                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â”‚                                       â”‚
â”‚                                      â–¼                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Score Calculator                                   â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  COMPOSITE_SCORE = (                                                 â”‚   â”‚
â”‚  â”‚      intimacy * 0.30 +                                               â”‚   â”‚
â”‚  â”‚      passion * 0.25 +                                                â”‚   â”‚
â”‚  â”‚      trust * 0.25 +                                                  â”‚   â”‚
â”‚  â”‚      secureness * 0.20                                               â”‚   â”‚
â”‚  â”‚  )                                                                   â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  Each metric: 0-100, clamped after delta application                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â”‚                                       â”‚
â”‚                                      â–¼                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    State Updater                                      â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  â€¢ Update user_metrics table                                         â”‚   â”‚
â”‚  â”‚  â€¢ Update users.relationship_score                                   â”‚   â”‚
â”‚  â”‚  â€¢ Check chapter advancement conditions                              â”‚   â”‚
â”‚  â”‚  â€¢ Trigger boss if threshold met                                     â”‚   â”‚
â”‚  â”‚  â€¢ Log score_history                                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. Game State Machine

```
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚   NEW_USER     â”‚
                                    â”‚   score: 50%   â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚ First message
                                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              CHAPTER 1: CURIOSITY                            â”‚
â”‚                              Days 1-14 | Decay: -5%/day                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ACTIVE_PLAY    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  BOSS_AVAILABLE â”‚ â”‚
â”‚  â”‚  Score < 60%    â”‚        Score >= 60%                â”‚  "Worth my time"â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚          â”‚                                                       â”‚          â”‚
â”‚          â”‚ Score = 0%                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚          â”‚                                       â”‚                      â”‚   â”‚
â”‚          â–¼                                       â–¼                      â–¼   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   GAME_OVER     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  BOSS_FAIL  â”‚        â”‚BOSS_PASSâ”‚ â”‚
â”‚  â”‚   (Dumped)      â”‚   3 failures       â”‚  attempts++ â”‚        â”‚         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”˜
                                                                      â”‚
                                                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              CHAPTER 2: INTRIGUE                             â”‚
â”‚                              Days 15-35 | Decay: -4%/day                     â”‚
â”‚  [Same pattern: ACTIVE â†’ BOSS_AVAILABLE (65%) â†’ PASS/FAIL]                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              CHAPTER 3: INVESTMENT                           â”‚
â”‚                              Days 36-70 | Decay: -3%/day                     â”‚
â”‚  [Same pattern: ACTIVE â†’ BOSS_AVAILABLE (70%) â†’ PASS/FAIL]                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              CHAPTER 4: INTIMACY                             â”‚
â”‚                              Days 71-120 | Decay: -2%/day                    â”‚
â”‚  [Same pattern: ACTIVE â†’ BOSS_AVAILABLE (75%) â†’ PASS/FAIL]                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              CHAPTER 5: ESTABLISHED                          â”‚
â”‚                              Days 121+ | Decay: -1%/day                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ACTIVE_PLAY    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  FINAL_BOSS     â”‚ â”‚
â”‚  â”‚  Score < 80%    â”‚        Score >= 80%                â”‚  "Ultimate test"â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                  â”‚          â”‚
â”‚                                                                  â–¼          â”‚
â”‚                                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚                                                         â”‚    GAME_WON     â”‚ â”‚
â”‚                                                         â”‚   Victory msg   â”‚ â”‚
â”‚                                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. Memory Pipeline (Graphiti Integration)

**Implementation**: `nikita/memory/graphiti_client.py` (271 lines)

### Three Knowledge Graphs
| Graph | Purpose | Entity Types |
|-------|---------|--------------|
| Nikita Graph | Her simulated life | WorkProject, LifeEvent, Opinion, Memory |
| User Graph | What she knows of player | UserFact, UserPreference, UserPattern |
| Relationship Graph | Shared history | Episode, Milestone, InsideJoke, Conflict |

### Key Methods
- `add_episode(content, source, graph_type)` - Add to any graph
- `search_memory(query, graph_types, limit)` - Hybrid search
- `get_context_for_prompt(user_message)` - Build LLM context
- `add_user_fact(fact, confidence)` - Store learned facts
- `get_user_facts(limit)` - Retrieve for deduplication

---

## 8. Agent Implementation

**Text Agent** âœ… COMPLETE - `nikita/agents/text/` (8 files, 1072 lines)
- `agent.py` - Pydantic AI agent with dynamic system prompt
- `handler.py` - MessageHandler with timing + skip logic
- `deps.py` - NikitaDeps dependency container
- `timing.py` - ResponseTimer (gaussian delay distribution)
- `skip.py` - SkipDecision (chapter-based skip rates)
- `facts.py` - FactExtractor (LLM-based fact extraction)
- `tools.py` - recall_memory, note_user_fact tools

**Voice Agent** âŒ TODO (Phase 4) - See `specs/007-voice-agent/spec.md`

---

## 8.5 Meta-Prompt Architecture âœ… COMPLETE

**Problem Solved**: All prompt generation used static f-string templates ("dumb templates"). Now uses LLM-generated prompts via meta-prompts.

**Module**: `nikita/meta_prompts/` (3 Python files, 4 templates, 1 CLAUDE.md)

```
nikita/meta_prompts/
â”œâ”€â”€ __init__.py              # Module exports
â”œâ”€â”€ service.py               # MetaPromptService (Claude Haiku)
â”œâ”€â”€ models.py                # ViceProfile, MetaPromptContext, GeneratedPrompt
â”œâ”€â”€ CLAUDE.md                # Module documentation
â””â”€â”€ templates/
    â”œâ”€â”€ system_prompt.meta.md      # 6-layer system prompt generation
    â”œâ”€â”€ vice_detection.meta.md     # 8 vice categories detection
    â”œâ”€â”€ entity_extraction.meta.md  # Post-processing extraction
    â””â”€â”€ thought_simulation.meta.md # Nikita's inner life
```

**Key Classes**:
- `MetaPromptService`: Central service for all meta-prompt operations
- `MetaPromptContext`: Aggregates user, game state, vice profile, temporal, memory context
- `ViceProfile`: 8 vice category intensities (0-5 each)
- `GeneratedPrompt`: Result with content, token count, timing

**Integration Points**:
- `template_generator.py` â†’ delegates to MetaPromptService.generate_system_prompt()
- `post_processor.py` â†’ uses MetaPromptService.extract_entities()
- `agent.py` â†’ build_system_prompt() uses context module â†’ MetaPromptService

**Key Decisions**:
- **Model**: Claude 3.5 Haiku (fast ~150ms, cheap ~$0.005/call)
- **Caching**: None initially (low cache hit rate due to temporal context)
- **Content**: Full adult - NO limits except underage (legal requirement)
- **Vice Integration**: User vice_profile actively shapes prompts

---

## 9. Database Schema

*Full schema: `memory/backend.md` and `nikita/db/models/`*

| Table | Purpose |
|-------|---------|
| users | Core user state, chapter, score |
| user_metrics | Hidden sub-metrics (intimacy, passion, trust, secureness) |
| user_vice_preferences | Vice category tracking (8 categories) |
| conversations | Session logs with JSONB messages |
| score_history | Score changes over time |
| daily_summaries | Nikita's in-character recaps |
| scheduled_events | Proactive messaging queue (delayed texts, outbound calls) |
| message_embeddings | pgVector embeddings for semantic search |

---

## 10. API Endpoints

| Route | Method | Purpose |
|-------|--------|---------|
| `/telegram/webhook` | POST | Handle Telegram bot messages (aiogram in webhook mode) |
| `/tasks/decay` | POST | Apply daily decay (pg_cron triggered) |
| `/tasks/deliver` | POST | Deliver scheduled messages (pg_cron triggered) |
| `/tasks/summary` | POST | Generate daily summaries (pg_cron triggered) |
| `/voice/elevenlabs/server-tool` | POST | ElevenLabs server tool callbacks |
| `/portal/stats/{user_id}` | GET | Player stats for dashboard |

*Full endpoint specs: `specs/002-telegram-integration`, `specs/007-voice-agent`, `specs/008-player-portal`*

---

## 11. Background Tasks (pg_cron + Edge Functions)

**Architecture**: pg_cron triggers Supabase Edge Functions â†’ calls Cloud Run API endpoints

| Task | Schedule | Trigger | Purpose |
|------|----------|---------|---------|
| `apply_daily_decay` | Daily 3am UTC | pg_cron â†’ Edge Function â†’ POST /tasks/decay | Apply chapter-specific score decay |
| `deliver_pending_msgs` | Every 30s | pg_cron â†’ Edge Function â†’ POST /tasks/deliver | Send delayed Nikita responses |
| `generate_daily_summaries` | Daily 4am UTC | pg_cron â†’ Edge Function â†’ POST /tasks/summary | Generate Nikita's in-character recap |

**Why not Celery/Redis?** Eliminates operational overhead. pg_cron is built into Supabase, Edge Functions are serverless.

*Full task specs: `specs/011-background-tasks`*

---

## 12. Deployment Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PRODUCTION DEPLOYMENT (Serverless)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  USER INTERFACES                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   Telegram Bot     â”‚   Voice Calls      â”‚   Player Portal             â”‚   â”‚
â”‚  â”‚   (aiogram 3.x)    â”‚   (Twilio)         â”‚   (Next.js on Vercel)       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚            â”‚ webhook            â”‚ audio stream            â”‚ REST API        â”‚
â”‚            â”‚                    â–¼                         â”‚                 â”‚
â”‚            â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚                 â”‚
â”‚            â”‚           â”‚  ELEVENLABS        â”‚             â”‚                 â”‚
â”‚            â”‚           â”‚  Conv AI 2.0       â”‚             â”‚                 â”‚
â”‚            â”‚           â”‚  (handles audio)   â”‚             â”‚                 â”‚
â”‚            â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚                 â”‚
â”‚            â”‚                     â”‚ Server Tools (REST)    â”‚                 â”‚
â”‚            â–¼                     â–¼                        â–¼                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                        GOOGLE CLOUD RUN                               â”‚  â”‚
â”‚  â”‚                    FastAPI + Pydantic AI + Claude                     â”‚  â”‚
â”‚  â”‚                         (Python 3.11+)                                â”‚  â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚  â”‚
â”‚  â”‚  Endpoints:                                                           â”‚  â”‚
â”‚  â”‚  â€¢ POST /telegram/webhook     (Telegram messages)                     â”‚  â”‚
â”‚  â”‚  â€¢ POST /voice/get-context    (ElevenLabs Server Tool)                â”‚  â”‚
â”‚  â”‚  â€¢ POST /voice/score-turn     (ElevenLabs Server Tool)                â”‚  â”‚
â”‚  â”‚  â€¢ POST /tasks/decay          (pg_cron webhook)                       â”‚  â”‚
â”‚  â”‚  â€¢ POST /tasks/deliver        (pg_cron webhook)                       â”‚  â”‚
â”‚  â”‚  â€¢ GET  /portal/stats/{id}    (Portal API)                            â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  Scaling: min=0, max=10 (scales to zero when idle)                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚            â”‚                   â”‚                       â”‚                    â”‚
â”‚            â–¼                   â–¼                       â–¼                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  SUPABASE        â”‚  â”‚  NEO4J AURA CLOUD  â”‚  â”‚  LLM SERVICES         â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚  â”‚  (FREE TIER)       â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”‚   â”‚
â”‚  â”‚  â€¢ Auth (OTP)    â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚  â”‚  â€¢ Claude Sonnet 4    â”‚   â”‚
â”‚  â”‚  â€¢ PostgreSQL    â”‚  â”‚  Graphiti KGs:     â”‚  â”‚  â€¢ OpenAI Embeddings  â”‚   â”‚
â”‚  â”‚  â€¢ pgVector      â”‚  â”‚  â€¢ nikita_graph    â”‚  â”‚                       â”‚   â”‚
â”‚  â”‚  â€¢ pg_cron â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â–º (triggers tasks) â”‚  â”‚                       â”‚   â”‚
â”‚  â”‚  â€¢ Edge Functionsâ”‚  â”‚  â€¢ user_graph      â”‚  â”‚                       â”‚   â”‚
â”‚  â”‚                  â”‚  â”‚  â€¢ relationship_   â”‚  â”‚                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  Voice Cold Start Mitigation:                                               â”‚
â”‚    Default: min-instances=0 (scales to zero)                                â”‚
â”‚    If latency issues: set min-instances=1 (~$6/mo extra)                    â”‚
â”‚                                                                              â”‚
â”‚  Cost Estimate: $35-65/mo (usage-based, can scale to near-free)             â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 13. Implementation Phases

### Phase 1: Core Infrastructure âœ… COMPLETE
- [x] Project structure (39 Python files)
- [x] Supabase database models defined
- [x] Graphiti integration (NikitaMemory) - migrating to Neo4j Aura
- [x] FastAPI skeleton
- [x] Pydantic models
- [x] Game constants (CHAPTERS, DECAY_RATES, CHAPTER_BEHAVIORS)

### Phase 2: Text Agent âš ï¸ 95% COMPLETE
**Text Agent Core** âœ… COMPLETE (specs/001-nikita-text-agent)
- [x] Pydantic AI agent with Nikita persona (nikita/agents/text/)
- [x] Memory tools (recall_memory, note_user_fact)
- [x] MessageHandler with timing + skip logic
- [x] FactExtractor for user fact learning
- [x] 156 tests passing

**Telegram Platform** âœ… COMPLETE (Sprint 2-3)
- [x] TelegramBot, TelegramAuth, CommandHandler (nikita/platforms/telegram/)
- [x] MessageHandler + RateLimiter + ResponseDelivery
- [x] pending_registrations DB migration (T046)
- [x] 74 tests passing

**API Routes** âœ… COMPLETE (Sprint 3)
- [x] Full DI in main.py (lifespan, health checks)
- [x] Telegram webhook (nikita/api/routes/telegram.py)
- [x] Task routes for pg_cron (nikita/api/routes/tasks.py)
- [x] 23 API tests passing

**Remaining Phase 2** (5%):
- [ ] Wire text_agent in MessageHandler (currently None)
- [ ] Deploy to Cloud Run + set Telegram webhook URL

### Phase 3: Game Engine âŒ TODO
- [ ] Scoring calculator (specs/003-scoring-engine)
- [ ] Chapter state machine (specs/004-chapter-boss-system)
- [ ] Decay scheduler (specs/005-decay-system)
- [ ] Vice discovery (specs/006-vice-personalization)

### Phase 4: Voice Agent âŒ TODO
- [ ] ElevenLabs integration (specs/007-voice-agent)
- [ ] Server tools
- [ ] Voice session management

### Phase 5: Portal & Polish âŒ TODO
- [ ] Next.js dashboard (specs/008-player-portal)
- [ ] Daily summaries
- [ ] Logging/monitoring

---

## 14. Key Documentation References

| Resource | URL |
|----------|-----|
| ElevenLabs Agents SDK | https://elevenlabs.io/docs/agents-platform/libraries/python |
| ElevenLabs Server Tools | https://elevenlabs.io/docs/agents-platform/customization/tools/server-tools |
| Pydantic AI Docs | https://ai.pydantic.dev/ |
| Pydantic AI Agents | https://ai.pydantic.dev/agents/ |
| Pydantic AI Tools | https://ai.pydantic.dev/tools/ |
| Graphiti GitHub | https://github.com/getzep/graphiti |
| Graphiti Temporal KG | https://arxiv.org/abs/2501.13956 |
| Supabase Python | https://supabase.com/docs/reference/python |
| Supabase pgVector | https://supabase.com/docs/guides/ai |
| aiogram 3.x | https://docs.aiogram.dev/ |
| FastAPI WebSockets | https://fastapi.tiangolo.com/advanced/websockets/ |

---

## 15. Architecture Decisions (Finalized)

### 15.1 Hosting
- **Primary**: Supabase hosted (PostgreSQL + Auth + Storage)
- **API**: Self-hosted or Supabase Edge Functions
- **Graph DB**: Neo4j Aura Free tier (managed, zero install)

### 15.2 ElevenLabs Configuration
- **Agent ID**: `PB6BdkFkZLbI39GHdnbQ` (abstracted for easy switching)
- **Design**: Agent ID configurable per chapter/mood - stored in config, not hardcoded

```python
# config/agents.py
ELEVENLABS_AGENTS = {
    "default": "PB6BdkFkZLbI39GHdnbQ",
    "chapter_1": "PB6BdkFkZLbI39GHdnbQ",  # Can customize per chapter
    "boss_fight": "PB6BdkFkZLbI39GHdnbQ",  # Different voice for intensity
}
```

### 15.3 Database Architecture (REVISED)

**Supabase handles ALL persistent data:**
- User profiles, auth (OTP)
- Conversation logs, transcriptions
- Score history, daily summaries
- User memory (raw facts)
- Vice preferences
- Game state

**Neo4j Aura (via Graphiti) handles ONLY temporal knowledge graphs:**
- Nikita Graph (her life/work/story)
- User Graph (what she knows about player)
- Relationship Graph (shared history/episodes)

### 15.4 Graph Database Decision

**Evaluated Options:**

| Option | Cost | Graphiti Support | Status |
|--------|------|------------------|--------|
| Kuzu | $0 | Yes | âŒ **ARCHIVED Oct 2025** |
| FalkorDB Free | $0 | Yes | âŒ Requires self-hosting (ops burden) |
| Neo4j Aura Free | $0 | Yes (native) | âœ… **SELECTED** - Managed, zero install |
| Neo4j Aura Professional | $65/mo | Yes | Upgrade path for production |

**Decision**: **Neo4j Aura Free tier** (2025-11 Update)
- Install: `pip install graphiti-core` (Neo4j is default backend)
- **Why change from FalkorDB?** Senior architect review: eliminate ops burden
- Neo4j Aura Free tier: 200k nodes, 400k relationships (sufficient for MVP)
- Zero installation, managed service, automatic backups
- Graphiti natively supports Neo4j - minimal code changes

**Connection Config:**
```python
# settings.py
NEO4J_URI = "neo4j+s://xxxx.databases.neo4j.io"
NEO4J_USERNAME = "neo4j"
NEO4J_PASSWORD = "..."  # from Aura console
```

### 15.5 Authentication
- **Method**: Supabase Auth with OTP (phone/email magic link)
- **Flow**: Telegram bot â†’ links to portal â†’ OTP login â†’ session
- **No passwords** - simple magic link flow

### 15.6 Content Moderation
- **Level**: None (0%)
- **18+ game**: Full adult content allowed
- **Vice system**: Unrestricted discussion of sex, drugs, etc.
- **No content filtering** on LLM outputs

---

## 16. Revised Tech Stack (Streamlined Nov 2025)

| Layer | Technology | Cost | Purpose |
|-------|------------|------|---------|
| **Compute** | Google Cloud Run | $0-20/mo | Serverless API hosting (scales to zero) |
| **Database** | Supabase Pro | ~$25/mo | All persistent data, embeddings, auth, pg_cron |
| **Graph DB** | Neo4j Aura Free | $0 | Temporal knowledge graphs via Graphiti |
| **Voice Agent** | ElevenLabs Conv AI 2.0 | ~$4/user/mo | Real-time voice (Server Tools pattern) |
| **Text Agent** | Pydantic AI + Claude Sonnet | ~$15/user/mo | Structured text responses |
| **Scheduling** | pg_cron + Edge Functions | $0 (included) | Background jobs (decay, msg delivery) |
| **Telegram Bot** | aiogram 3.x | $0 | Async Telegram integration |
| **Portal** | Next.js | Vercel free | Stats dashboard |
| **Voice Dial** | Twilio | $10-20/mo | Voice call initiation |

**What we removed (Senior Architect Review):**
- âŒ Celery + Redis (over-engineered for MVP)
- âŒ Self-hosted FalkorDB (maintenance burden)
- âŒ Always-on VPS/VM (wasteful for idle periods)

**Estimated monthly cost (MVP)**: $35-65/mo (usage-based, can scale to near-free)

---

## 17. ElevenLabs Agent Abstraction

*Implementation: `nikita/config/elevenlabs.py`*

- Agent IDs configurable per chapter/mood/boss_fight
- `get_agent_id(chapter, mood, is_boss)` â†’ returns appropriate agent ID
- Environment prefix: `ELEVENLABS_`

---

## 18. Security Remediation (Dec 2025)

**Source**: Backend/DB Security Audit (`docs-to-process/20251201-analysis-backend-db-audit.md`)
**Verified**: Against actual Supabase database via MCP tools (2025-12-01)

### 18.1 Identified Issues

| Issue | Severity | Status | Migration |
|-------|----------|--------|-----------|
| message_embeddings missing user_id | CRITICAL | âœ… Fixed | 0003 |
| RLS policies use `auth.uid()` (slow) | HIGH | âœ… Fixed | 0004 |
| Duplicate permissive policies | HIGH | âœ… Fixed | 0005 |
| Extensions in public schema | MEDIUM | âœ… Fixed | 0006 |
| In-memory pending_registrations | HIGH | âœ… Table created | 0006 |

### 18.2 RLS Best Practices (CRITICAL)

```sql
-- ALWAYS use (select auth.uid()) NOT auth.uid()
-- This evaluates once per query instead of per row (50-100x faster)

CREATE POLICY "users_own_data" ON users
    FOR ALL USING (id = (select auth.uid()))
    WITH CHECK (id = (select auth.uid()));

-- Use single FOR ALL policy, NOT separate SELECT/INSERT/UPDATE policies
```

### 18.3 Migrations Created

| Migration | Purpose | Location |
|-----------|---------|----------|
| 0003 | Fix message_embeddings user_id | `nikita/db/migrations/versions/20251128_0003_fix_message_embeddings.py` |
| 0004 | RLS performance optimization | `nikita/db/migrations/versions/20251128_0004_rls_performance.py` |
| 0005 | Consolidate duplicate policies | `nikita/db/migrations/versions/20251128_0005_consolidate_policies.py` |
| 0006 | Extensions schema + pending_registrations | `nikita/db/migrations/versions/20251128_0006_extensions_pending_reg.py` |

**Apply**: Run `alembic upgrade head` or use Supabase MCP `apply_migration` tool

---

*Documentation: see memory/*.md files for detailed architecture*
